const axios = require('axios');

const API_BASE_URL = 'http://localhost:3000/api';

// Sample admin token - replace with actual admin token
const ADMIN_TOKEN = 'your-admin-token-here';

const headers = {
  Authorization: `Bearer ${ADMIN_TOKEN}`,
  'Content-Type': 'application/json',
};

async function testPricingAPI() {
  console.log('üß™ Testing Pricing API Endpoints...\n');

  try {
    // 1. Initialize default pricing data
    console.log('1Ô∏è‚É£ Initializing default pricing data...');
    const initResponse = await axios.post(
      `${API_BASE_URL}/admin/pricing/initialize`,
      {},
      { headers },
    );
    console.log('‚úÖ Default pricing initialized:', initResponse.status);

    // 2. Get all pricing entries
    console.log('\n2Ô∏è‚É£ Fetching all pricing entries...');
    const getAllResponse = await axios.get(`${API_BASE_URL}/admin/pricing`, { headers });
    console.log('‚úÖ Pricing entries fetched:', getAllResponse.data.length, 'entries');

    // 3. Get filtered pricing entries
    console.log('\n3Ô∏è‚É£ Fetching subscription pricing entries...');
    const getFilteredResponse = await axios.get(`${API_BASE_URL}/admin/pricing?type=subscription`, {
      headers,
    });
    console.log('‚úÖ Subscription pricing entries:', getFilteredResponse.data.length, 'entries');

    // 4. Test price retrieval endpoints
    console.log('\n4Ô∏è‚É£ Testing price retrieval endpoints...');

    try {
      const studentPriceResponse = await axios.get(
        `${API_BASE_URL}/admin/pricing/subscription-price?userRole=Student&frequency=annual`,
        { headers },
      );
      console.log('‚úÖ Student annual price:', studentPriceResponse.data);
    } catch (error) {
      console.log('‚ùå Student price error:', error.message);
    }

    try {
      const doctorPriceResponse = await axios.get(
        `${API_BASE_URL}/admin/pricing/subscription-price?userRole=Doctor&frequency=annual`,
        { headers },
      );
      console.log('‚úÖ Doctor annual price:', doctorPriceResponse.data);
    } catch (error) {
      console.log('‚ùå Doctor price error:', error.message);
    }

    try {
      const incomeBasedPriceResponse = await axios.get(
        `${API_BASE_URL}/admin/pricing/income-based-price?incomeBracket=less_than_50k&frequency=annual`,
        { headers },
      );
      console.log('‚úÖ Income-based price (less than 50k, annual):', incomeBasedPriceResponse.data);
    } catch (error) {
      console.log('‚ùå Income-based price error:', error.message);
    }

    try {
      const lifetimePriceResponse = await axios.get(
        `${API_BASE_URL}/admin/pricing/lifetime-price?membershipType=gold`,
        { headers },
      );
      console.log('‚úÖ Lifetime gold price:', lifetimePriceResponse.data);
    } catch (error) {
      console.log('‚ùå Lifetime price error:', error.message);
    }

    // 5. Create a new pricing entry
    console.log('\n5Ô∏è‚É£ Creating new pricing entry...');
    const newPricing = {
      type: 'subscription',
      userRole: 'Student',
      frequency: 'monthly',
      amount: 100,
      currency: 'NGN',
      description: 'Test monthly student pricing',
      isActive: true,
    };

    try {
      const createResponse = await axios.post(`${API_BASE_URL}/admin/pricing`, newPricing, {
        headers,
      });
      console.log('‚úÖ New pricing entry created:', createResponse.data._id);

      // 6. Update the pricing entry
      console.log('\n6Ô∏è‚É£ Updating pricing entry...');
      const updateData = { amount: 150, description: 'Updated test pricing' };
      const updateResponse = await axios.put(
        `${API_BASE_URL}/admin/pricing/${createResponse.data._id}`,
        updateData,
        { headers },
      );
      console.log('‚úÖ Pricing entry updated:', updateResponse.data.amount);

      // 7. Delete the pricing entry
      console.log('\n7Ô∏è‚É£ Deleting pricing entry...');
      await axios.delete(`${API_BASE_URL}/admin/pricing/${createResponse.data._id}`, { headers });
      console.log('‚úÖ Pricing entry deleted');
    } catch (error) {
      console.log('‚ùå CRUD operations error:', error.response?.data || error.message);
    }

    console.log('\nüéâ All tests completed!');
  } catch (error) {
    console.error('‚ùå API Test failed:', error.response?.data || error.message);

    if (error.response?.status === 401) {
      console.log('\nüí° Note: You need to replace ADMIN_TOKEN with a valid admin token');
      console.log('   1. Login as admin user');
      console.log('   2. Copy the JWT token from the response');
      console.log('   3. Update the ADMIN_TOKEN variable in this script');
    }
  }
}

// Run the test
testPricingAPI();
